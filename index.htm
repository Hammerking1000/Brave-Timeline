<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Tracker</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; }

        /* NAV */
        nav { background: #1a1a2e; padding: 0 24px; display: flex; align-items: center; gap: 8px; height: 56px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .nav-logo { color: #fff; font-size: 18px; font-weight: 700; margin-right: 24px; letter-spacing: -0.5px; }
        .nav-logo span { color: #4fc3f7; }
        .nav-tab { color: #aaa; padding: 0 16px; height: 56px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-tab:hover { color: #fff; }
        .nav-tab.active { color: #fff; border-bottom-color: #4fc3f7; }
        .nav-spacer { flex: 1; }

        /* LAYOUT */
        .page { display: none; padding: 28px; }
        .page.active { display: block; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* BUTTONS */
        .action-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 9px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: #2196F3; color: #fff; }
        .btn-primary:hover { background: #1976D2; }
        .btn-ghost { background: transparent; color: #555; border: 1px solid #ddd; }
        .btn-ghost:hover { background: #f5f5f5; }
        .btn-danger { background: #e53935; color: #fff; }
        .btn-danger:hover { background: #c62828; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-icon { padding: 6px 10px; font-size: 16px; }

        /* CARDS & TABLES */
        .card { background: #fff; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); overflow: visible; position: relative; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 14px 18px; background: #fafafa; font-weight: 600; color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #eee; }
        td { padding: 14px 18px; border-bottom: 1px solid #f3f3f3; color: #333; font-size: 14px; position: relative; }
        tbody tr { transition: background 0.15s; position: relative; }
        tbody tr:hover { background: #f0f7ff; }
        tbody tr:last-child td { border-bottom: none; }

        .order-num-badge { color: #2196F3; font-weight: 700; padding: 6px 14px; border: 2px solid #2196F3; border-radius: 6px; display: inline-block; min-width: 72px; text-align: center; }
        
        /* STATUS */
        .status-wrap { position: relative; display: inline-block; }
        .status-badge { padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; border: none; transition: opacity 0.15s; white-space: nowrap; }
        .status-badge:hover { opacity: 0.82; }
        .status-badge::after { content: ' ‚ñæ'; font-size: 10px; }
        .status-bid { background: #fff3e0; color: #e65100; }
        .status-ordered { background: #e3f2fd; color: #0d47a1; }
        .status-verified { background: #e0f2f1; color: #00695c; }
        .status-progress { background: #ede7f6; color: #4527a0; }
        .status-hold { background: #fce4ec; color: #880e4f; }
        .status-completed { background: #e8f5e9; color: #1b5e20; }
        .status-shipped { background: #f3e5f5; color: #6a1b9a; }
        .status-void { background: #eeeeee; color: #616161; }
        
        .status-menu { display: none; position: absolute; top: calc(100% + 4px); left: 0; background: #fff; border-radius: 8px; box-shadow: 0 6px 24px rgba(0,0,0,0.15); z-index: 1000; min-width: 170px; overflow: visible; border: 1px solid #eee; }
        .status-menu.open { display: block; }
        .status-menu-item { padding: 10px 16px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; transition: background 0.1s; }
        .status-menu-item:hover { background: #f5f5f5; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

        /* TOGGLE SWITCHES */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f5f5f5; }
        .toggle-row:last-child { border-bottom: none; }
        .toggle-label { font-size: 14px; color: #444; }
        .toggle { position: relative; width: 42px; height: 24px; background: #ccc; border-radius: 12px; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
        .toggle.on { background: #2196F3; }
        .toggle-knob { position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; background: #fff; border-radius: 50%; transition: left 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle.on .toggle-knob { left: 21px; }

        /* PRICING MATRIX PAGE */
        .matrix-table-wrapper { overflow-x: auto; }
        .matrix-table { width: 100%; min-width: 1000px; }
        .matrix-table th { position: sticky; top: 0; z-index: 10; }
        .matrix-table td { position: relative; }
        .matrix-table input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: right; }
        .matrix-table input:focus { outline: none; border-color: #2196F3; background: #f0f7ff; }
        .matrix-header { background: #2196F3; color: white; text-align: center; }
        .range-label { font-weight: 600; color: #333; background: #f8f8f8; }
        .num-center { text-align: center; }
        .num-right { text-align: right; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 500; align-items: center; justify-content: center; }
        .modal.open { display: flex; }
        .modal-box { background: #fff; border-radius: 12px; padding: 32px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 700; color: #1a1a2e; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #aaa; }
        
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; color: #444; }
        .form-input, .form-select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 7px; font-size: 14px; transition: border-color 0.15s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #2196F3; }
        .form-actions { display: flex; gap: 10px; margin-top: 24px; }
        .form-actions .btn { flex: 1; justify-content: center; }

        /* BUILDER */
        .selected-builtins { border: 1px solid #e0e0e0; border-radius: 8px; max-height: 280px; overflow-y: auto; }
        .selected-builtin-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-bottom: 1px solid #f0f0f0; }
        .selected-builtin-item:last-child { border-bottom: none; }
        .selected-builtin-name { flex: 1; font-size: 14px; color: #333; font-weight: 500; }
        .selected-builtin-qty { width: 60px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 13px; }
        .selected-builtin-price { font-size: 14px; color: #666; min-width: 80px; text-align: right; }
        .selected-builtin-remove { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; }
        .selected-builtin-remove:hover { color: #e53935; }
        .order-total-box { background: #f8f8f8; border-radius: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: center; margin-top: 16px; }
        .order-total-label { font-size: 16px; font-weight: 700; color: #333; }
        .order-total-value { font-size: 22px; font-weight: 700; color: #2196F3; }
        .empty-state { text-align: center; padding: 40px 20px; color: #aaa; font-size: 14px; }

        /* SELECTOR */
        .builtin-selector-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 600; align-items: center; justify-content: center; overflow-y: auto; }
        .builtin-selector-overlay.open { display: flex; }
        .builtin-selector-panel { background: #fff; border-radius: 12px; width: 95%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: 20px; }
        .builtin-selector-header { padding: 24px 28px; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .builtin-selector-title { font-size: 22px; font-weight: 700; color: #1a1a2e; }
        .builtin-selector-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #aaa; padding: 0; }
        .builtin-selector-body { padding: 28px; overflow-y: auto; flex: 1; }
        .builtin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .builtin-card { background: #fafafa; border: 2px solid #e0e0e0; border-radius: 10px; padding: 18px; transition: all 0.2s; cursor: pointer; text-align: center; }
        .builtin-card:hover { border-color: #2196F3; background: #f0f7ff; transform: translateY(-2px); }
        .builtin-card-name { font-size: 16px; font-weight: 600; color: #1a1a2e; margin-bottom: 8px; }
        .builtin-card-category { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }

        /* TOAST */
        .toast-container { position: fixed; bottom: 28px; right: 28px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #1a1a2e; color: #fff; padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.25); font-size: 14px; display: flex; align-items: center; gap: 12px; min-width: 300px; animation: slideIn 0.3s ease; }
        .toast-body { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 2px; }
        .toast-msg { font-size: 12px; color: #aaa; }
        .toast-close { background: none; border: none; color: #aaa; cursor: pointer; font-size: 18px; }
        @keyframes slideIn { from { transform: translateX(60px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<nav>
    <div class="nav-logo">BR‚ñ≤‚ñºE<span> Timeline X</span></div>
    <button class="nav-tab active" onclick="showPage('orders', this)">Orders</button>
    <button class="nav-tab" onclick="showPage('matrix', this)">Pricing Matrix</button>
    <div class="nav-spacer"></div>
    <button class="nav-tab" onclick="showPage('settings', this)" style="border-left:1px solid #333;">Settings</button>
</nav>

<!-- ORDERS PAGE -->
<div id="page-orders" class="page active">
    <div class="container">
        <div class="action-bar">
            <button class="btn btn-primary" onclick="openOrderModal()">+ New Order</button>
        </div>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Company</th>
                        <th>Name</th>
                        <th class="num-center"># Built-ins</th>
                        <th>Ship Date</th>
                        <th>Status</th>
                        <th style="width:80px;"></th>
                    </tr>
                </thead>
                <tbody id="orders-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- PRICING MATRIX PAGE -->
<div id="page-matrix" class="page">
    <div class="container">
        <div class="action-bar">
            <button class="btn btn-primary" onclick="addNewCabinet()">+ Add Cabinet</button>
            <button class="btn btn-ghost" onclick="exportMatrix()">Export to CSV</button>
        </div>
        <div class="card">
            <div class="matrix-table-wrapper">
                <table class="matrix-table" id="matrix-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Cabinet Name</th>
                            <th rowspan="2">Width Range</th>
                            <th colspan="1" class="matrix-header">12" Depth</th>
                            <th colspan="1" class="matrix-header">18" Depth</th>
                            <th colspan="1" class="matrix-header">24" Depth</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th class="matrix-header">Price</th>
                            <th class="matrix-header">Price</th>
                            <th class="matrix-header">Price</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS PAGE -->
<div id="page-settings" class="page">
    <div class="container">
        <h2 style="font-size:22px;font-weight:700;color:#1a1a2e;margin-bottom:20px;">Settings</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;">
            <div class="card" style="padding:24px;">
                <div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid #f0f0f0;">üìß Status Change Notifications</div>
                <p style="font-size:13px;color:#888;margin-bottom:16px;">An email is sent to the addresses below whenever an order's status changes.</p>
                <label class="form-label">Notification Emails</label>
                <div id="email-tags" style="margin-bottom:12px;min-height:36px;">
                    <span style="display:inline-flex;align-items:center;gap:6px;background:#e3f2fd;color:#1565c0;padding:5px 12px;border-radius:20px;font-size:13px;margin:3px;">
                        shop@yourcompany.com <button onclick="this.closest('span').remove()" style="background:none;border:none;cursor:pointer;color:#1565c0;font-size:16px;line-height:1;">√ó</button>
                    </span>
                </div>
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <input type="email" class="form-input" id="new-email-input" placeholder="Add email‚Ä¶" style="flex:1;">
                    <button class="btn btn-primary btn-sm" onclick="addEmailTag()">Add</button>
                </div>
                <p style="font-size:12px;color:#aaa;margin-top:4px;">Press Add or Enter after each address.</p>
                
                <div style="margin-top:24px;padding-top:20px;border-top:2px solid #f0f0f0;">
                    <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:12px;">Send notifications for these status changes:</div>
                    
                    <div class="toggle-row">
                        <span class="toggle-label">BID ‚Üí ORDERED</span>
                        <div class="toggle on" onclick="this.classList.toggle('on')" data-transition="bid-ordered">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">ORDERED ‚Üí VERIFIED</span>
                        <div class="toggle on" onclick="this.classList.toggle('on')" data-transition="ordered-verified">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Any ‚Üí IN PROGRESS</span>
                        <div class="toggle on" onclick="this.classList.toggle('on')" data-transition="any-progress">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Any ‚Üí ON HOLD</span>
                        <div class="toggle on" onclick="this.classList.toggle('on')" data-transition="any-hold">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Any ‚Üí COMPLETED</span>
                        <div class="toggle on" onclick="this.classList.toggle('on')" data-transition="any-completed">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Any ‚Üí SHIPPED</span>
                        <div class="toggle on" onclick="this.classList.toggle('on')" data-transition="any-shipped">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card" style="padding:24px;">
                <div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid #f0f0f0;">‚öô General</div>
                <div class="form-group">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-input" value="Your Cabinet Co.">
                </div>
                <div class="form-group">
                    <label class="form-label">Default Status for New Orders</label>
                    <select class="form-select"><option>BID</option><option>ORDERED</option><option>VERIFIED</option></select>
                </div>
                <button class="btn btn-primary" style="margin-top:8px;">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- ORDER DETAIL PAGE -->
<div id="page-order-detail" class="page">
    <div class="container">
        <div class="action-bar">
            <button class="btn btn-ghost btn-sm" onclick="backToOrders()">‚Üê Back to Orders</button>
            <div style="margin-left:auto;display:flex;gap:10px;">
                <button class="btn btn-ghost btn-sm" onclick="editCurrentOrder()">Edit Order</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCurrentOrder()">Delete</button>
            </div>
        </div>
        
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;">
            <div>
                <div style="font-size:26px;font-weight:700;color:#1a1a2e;margin-bottom:6px;" id="detail-title">‚Äì</div>
                <div style="color:#888;font-size:14px;" id="detail-subtitle">‚Äì</div>
            </div>
            <div id="detail-status-wrap"></div>
        </div>
        
        <div class="card" style="padding:24px;margin-bottom:20px;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;">
                <div><div style="font-size:11px;color:#aaa;text-transform:uppercase;font-weight:600;letter-spacing:0.5px;margin-bottom:5px;">Order #</div><div style="font-size:15px;color:#222;font-weight:500;" id="di-order">‚Äì</div></div>
                <div><div style="font-size:11px;color:#aaa;text-transform:uppercase;font-weight:600;letter-spacing:0.5px;margin-bottom:5px;">Company</div><div style="font-size:15px;color:#222;font-weight:500;" id="di-company">‚Äì</div></div>
                <div><div style="font-size:11px;color:#aaa;text-transform:uppercase;font-weight:600;letter-spacing:0.5px;margin-bottom:5px;">Project Name</div><div style="font-size:15px;color:#222;font-weight:500;" id="di-name">‚Äì</div></div>
                <div><div style="font-size:11px;color:#aaa;text-transform:uppercase;font-weight:600;letter-spacing:0.5px;margin-bottom:5px;">Ship Date</div><div style="font-size:15px;color:#222;font-weight:500;" id="di-ship">‚Äì</div></div>
                <div><div style="font-size:11px;color:#aaa;text-transform:uppercase;font-weight:600;letter-spacing:0.5px;margin-bottom:5px;">Total Built-ins</div><div style="font-size:15px;color:#222;font-weight:500;" id="di-count">‚Äì</div></div>
            </div>
        </div>
        
        <div class="card" style="padding:24px;">
            <div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-bottom:18px;padding-bottom:12px;border-bottom:2px solid #f0f0f0;">Built-ins Breakdown</div>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Width</th>
                        <th>Depth</th>
                        <th class="num-right">Qty</th>
                        <th class="num-right">Unit Price</th>
                        <th class="num-right">Total</th>
                    </tr>
                </thead>
                <tbody id="detail-builtins-tbody"></tbody>
                <tfoot>
                    <tr style="background:#f8f8f8;">
                        <td colspan="5" style="text-align:right;font-weight:700;padding:14px;">ORDER TOTAL</td>
                        <td class="num-right" style="font-weight:700;" id="detail-total">$0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<!-- ORDER MODAL -->
<div class="modal" id="modal-order">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="modal-title">New Order</h2>
            <button class="modal-close" onclick="closeModal('modal-order')">√ó</button>
        </div>
        <div class="form-group">
            <label class="form-label">Order Number</label>
            <input type="text" class="form-input" id="order-number">
        </div>
        <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" class="form-input" id="order-company">
        </div>
        <div class="form-group">
            <label class="form-label">Project Name</label>
            <input type="text" class="form-input" id="order-name">
        </div>
        <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="order-status">
                <option value="bid">BID</option><option value="ordered">ORDERED</option>
                <option value="verified">VERIFIED</option><option value="progress">IN PROGRESS</option>
                <option value="hold">ON HOLD</option><option value="completed">COMPLETED</option>
                <option value="shipped">SHIPPED</option><option value="void">VOID</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Ship Date</label>
            <input type="date" class="form-input" id="order-ship">
        </div>
        <div style="margin-bottom:18px;">
            <label class="form-label">Built-ins</label>
            <button class="btn btn-primary" style="width:100%; justify-content:center; margin-bottom:12px;" onclick="openBuiltinSelector()">
                + Select Built-ins from Catalog
            </button>
            <div class="selected-builtins" id="order-builtins-list">
                <div class="empty-state">No built-ins added yet</div>
            </div>
            <div class="order-total-box">
                <span class="order-total-label">Order Total</span>
                <span class="order-total-value" id="order-modal-total">$0.00</span>
            </div>
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="saveOrder()">Create Order</button>
            <button class="btn btn-ghost" onclick="closeModal('modal-order')">Cancel</button>
        </div>
    </div>
</div>

<!-- WIDTH/DEPTH INPUT MODAL -->
<div class="modal" id="modal-dimensions">
    <div class="modal-box" style="max-width:450px;">
        <div class="modal-header">
            <h2 class="modal-title" id="dim-modal-title">Specify Dimensions</h2>
            <button class="modal-close" onclick="closeModal('modal-dimensions')">√ó</button>
        </div>
        <p style="font-size:14px;color:#666;margin-bottom:20px;" id="dim-cabinet-name"></p>
        <div class="form-group">
            <label class="form-label">Width (inches)</label>
            <input type="number" class="form-input" id="dim-width" placeholder="e.g., 27.5" step="0.125" min="0">
            <p class="form-hint" style="margin-top:6px;" id="dim-range-hint">Enter the exact width</p>
        </div>
        <div class="form-group">
            <label class="form-label">Depth (inches)</label>
            <select class="form-select" id="dim-depth">
                <option value="12">12"</option>
                <option value="18">18"</option>
                <option value="24" selected>24"</option>
            </select>
        </div>
        <div style="background:#f0f7ff;border-radius:8px;padding:16px;margin-bottom:20px;" id="dim-price-display">
            <div style="font-size:12px;color:#888;margin-bottom:4px;">Calculated Price</div>
            <div style="font-size:24px;font-weight:700;color:#2196F3;" id="dim-price">$0.00</div>
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="confirmDimensions()">Add to Order</button>
            <button class="btn btn-ghost" onclick="closeModal('modal-dimensions')">Cancel</button>
        </div>
    </div>
</div>

<!-- BUILTIN SELECTOR -->
<div class="builtin-selector-overlay" id="builtin-selector">
    <div class="builtin-selector-panel">
        <div class="builtin-selector-header">
            <h2 class="builtin-selector-title">Select Cabinet</h2>
            <button class="builtin-selector-close" onclick="closeBuiltinSelector()">√ó</button>
        </div>
        <div class="builtin-selector-body">
            <div class="builtin-grid" id="builtin-grid"></div>
        </div>
    </div>
</div>

<!-- CABINET MODAL -->
<div class="modal" id="modal-cabinet">
    <div class="modal-box" style="max-width:700px;">
        <div class="modal-header">
            <h2 class="modal-title" id="cabinet-modal-title">Add Cabinet</h2>
            <button class="modal-close" onclick="closeModal('modal-cabinet')">√ó</button>
        </div>
        <div class="form-group">
            <label class="form-label">Cabinet Name</label>
            <input type="text" class="form-input" id="cabinet-name" placeholder="e.g., B-O1A">
        </div>
        <div class="form-group">
            <label class="form-label">Category</label>
            <input type="text" class="form-input" id="cabinet-category" placeholder="e.g., Base Cabinets">
        </div>
        
        <div style="border-top:2px solid #f0f0f0;padding-top:18px;margin-top:18px;">
            <label class="form-label">Width Ranges & Pricing</label>
            <p style="font-size:12px;color:#aaa;margin-bottom:12px;">Define the width ranges and prices for each depth.</p>
            <div id="range-inputs"></div>
            <button class="btn btn-ghost btn-sm" onclick="addRangeRow()">+ Add Width Range</button>
        </div>

        <div class="form-actions">
            <button class="btn btn-primary" onclick="saveCabinet()">Save Cabinet</button>
            <button class="btn btn-ghost" onclick="closeModal('modal-cabinet')">Cancel</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TODO: Replace this with your Firebase config from Firebase Console
// Go to: Firebase Console ‚Üí Project Settings ‚Üí General ‚Üí Your apps ‚Üí Web app
const firebaseConfig = {
  apiKey: "AIzaSyCTpfKPoMnylDHmDHzkcNFjsol1ryn893E",
  authDomain: "brave-timeline.firebaseapp.com",
  projectId: "brave-timeline",
  storageBucket: "brave-timeline.firebasestorage.app",
  messagingSenderId: "221637284494",
  appId: "1:221637284494:web:c799257657182fe0496fdf"
};

// Initialize Firebase
let db = null;
let firebaseInitialized = false;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    firebaseInitialized = true;
    console.log('‚úÖ Firebase connected successfully');
} catch (error) {
    console.error('‚ùå Firebase initialization error:', error);
    alert('Please update Firebase configuration in the code. See instructions at the top of the script section.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE SYNC FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function saveToFirebase(path, data) {
    if (!firebaseInitialized) return Promise.resolve();
    return db.ref(path).set(data);
}

function loadFromFirebase(path) {
    if (!firebaseInitialized) return Promise.resolve(null);
    return db.ref(path).once('value').then(snapshot => snapshot.val());
}

function listenToFirebase(path, callback) {
    if (!firebaseInitialized) return;
    db.ref(path).on('value', snapshot => {
        callback(snapshot.val());
    });
}

// Save orders to Firebase
function syncOrders() {
    saveToFirebase('orders', orders).catch(err => console.error('Error saving orders:', err));
}

// Save pricing matrix to Firebase
function syncPricingMatrix() {
    saveToFirebase('pricingMatrix', pricingMatrix).catch(err => console.error('Error saving pricing matrix:', err));
}

// Save notification settings
function syncNotificationSettings() {
    const settings = {
        emails: Array.from(document.querySelectorAll('#email-tags span')).map(span => 
            span.textContent.replace('√ó', '').trim()
        ),
        transitions: {}
    };
    
    document.querySelectorAll('[data-transition]').forEach(toggle => {
        const transition = toggle.getAttribute('data-transition');
        settings.transitions[transition] = toggle.classList.contains('on');
    });
    
    saveToFirebase('settings', settings).catch(err => console.error('Error saving settings:', err));
}

// Load all data from Firebase on startup
async function loadFromFirebaseOnStartup() {
    if (!firebaseInitialized) {
        console.log('‚ö†Ô∏è Firebase not initialized, using local data');
        return;
    }
    
    try {
        // Load orders
        const loadedOrders = await loadFromFirebase('orders');
        if (loadedOrders) {
            orders = loadedOrders;
            console.log('‚úÖ Loaded orders from Firebase');
        }
        
        // Load pricing matrix
        const loadedMatrix = await loadFromFirebase('pricingMatrix');
        if (loadedMatrix) {
            pricingMatrix = loadedMatrix;
            console.log('‚úÖ Loaded pricing matrix from Firebase');
        }
        
        // Load settings
        const loadedSettings = await loadFromFirebase('settings');
        if (loadedSettings) {
            // Restore email tags
            if (loadedSettings.emails) {
                const emailContainer = document.getElementById('email-tags');
                emailContainer.innerHTML = loadedSettings.emails.map(email => 
                    `<span style="display:inline-flex;align-items:center;gap:6px;background:#e3f2fd;color:#1565c0;padding:5px 12px;border-radius:20px;font-size:13px;margin:3px;">
                        ${email} <button onclick="this.closest('span').remove();syncNotificationSettings();" style="background:none;border:none;cursor:pointer;color:#1565c0;font-size:16px;line-height:1;">√ó</button>
                    </span>`
                ).join('');
            }
            
            // Restore toggle states
            if (loadedSettings.transitions) {
                Object.entries(loadedSettings.transitions).forEach(([transition, isOn]) => {
                    const toggle = document.querySelector(`[data-transition="${transition}"]`);
                    if (toggle) {
                        if (isOn) toggle.classList.add('on');
                        else toggle.classList.remove('on');
                    }
                });
            }
            
            console.log('‚úÖ Loaded settings from Firebase');
        }
        
        // Render UI with loaded data
        renderOrders();
        
    } catch (error) {
        console.error('Error loading from Firebase:', error);
    }
}

// Listen for real-time updates from other users
function setupRealtimeListeners() {
    if (!firebaseInitialized) return;
    
    // Listen for order changes
    listenToFirebase('orders', (data) => {
        if (data) {
            orders = data;
            renderOrders();
        }
    });
    
    // Listen for pricing matrix changes
    listenToFirebase('pricingMatrix', (data) => {
        if (data) {
            pricingMatrix = data;
            if (document.getElementById('page-matrix').classList.contains('active')) {
                renderMatrix();
            }
        }
    });
}

// DATA
const STATUSES = [
    { key:'bid',label:'BID',cls:'status-bid',dot:'#e65100' },
    { key:'ordered',label:'ORDERED',cls:'status-ordered',dot:'#0d47a1' },
    { key:'verified',label:'VERIFIED',cls:'status-verified',dot:'#00695c' },
    { key:'progress',label:'IN PROGRESS',cls:'status-progress',dot:'#4527a0' },
    { key:'hold',label:'ON HOLD',cls:'status-hold',dot:'#880e4f' },
    { key:'completed',label:'COMPLETED',cls:'status-completed',dot:'#1b5e20' },
    { key:'shipped',label:'SHIPPED',cls:'status-shipped',dot:'#6a1b9a' },
    { key:'void',label:'VOID',cls:'status-void',dot:'#616161' },
];

let pricingMatrix = [
    {"name":"B-O1A","category":"Base Cabinets","ranges":[{"label":"12\" to 17-7/8\"","minWidth":12,"maxWidth":17.875,"prices":{"12":304.5,"18":331.8,"24":359.1}},{"label":"18\" to 23-7/8\"","minWidth":18,"maxWidth":23.875,"prices":{"12":335,"18":365,"24":395}},{"label":"24\" to 36\"","minWidth":24,"maxWidth":36,"prices":{"12":369,"18":402,"24":435}}]},
    {"name":"B-O1A1W","category":"Base Cabinets","ranges":[{"label":"12\" to 17-7/8\"","minWidth":12,"maxWidth":17.875,"prices":{"12":405,"18":448,"24":495}},{"label":"18\" to 23-7/8\"","minWidth":18,"maxWidth":23.875,"prices":{"12":446,"18":493,"24":545}},{"label":"24\" to 36\"","minWidth":24,"maxWidth":36,"prices":{"12":491,"18":542,"24":600}}]},
    {"name":"B-1R","category":"Base Cabinets","ranges":[{"label":"12\" to 17-7/8\"","minWidth":12,"maxWidth":17.875,"prices":{"12":406,"18":442,"24":479}},{"label":"18\" to 23-7/8\"","minWidth":18,"maxWidth":23.875,"prices":{"12":447,"18":486,"24":527}}]},
    {"name":"B-1R1W","category":"Base Cabinets","ranges":[{"label":"12\" to 17-7/8\"","minWidth":12,"maxWidth":17.875,"prices":{"12":668,"18":764,"24":841}},{"label":"18\" to 23-7/8\"","minWidth":18,"maxWidth":23.875,"prices":{"12":701,"18":802,"24":883}}]},
    {"name":"B-2R","category":"Base Cabinets","ranges":[{"label":"24\" to 29-7/8\"","minWidth":24,"maxWidth":29.875,"prices":{"12":559,"18":608,"24":659}},{"label":"30\" to 36\"","minWidth":30,"maxWidth":36,"prices":{"12":615,"18":669,"24":725}}]},
    {"name":"B-2R1W","category":"Base Cabinets","ranges":[{"label":"24\" to 29-7/8\"","minWidth":24,"maxWidth":29.875,"prices":{"12":805,"18":928,"24":1072}},{"label":"30\" to 36\"","minWidth":30,"maxWidth":36,"prices":{"12":886,"18":1021,"24":1179}}]},
    {"name":"B-2WF","category":"Base Cabinets","ranges":[{"label":"15\" to 20-7/8\"","minWidth":15,"maxWidth":20.875,"prices":{"12":738,"18":803,"24":870}},{"label":"21\" to 29-7/8\"","minWidth":21,"maxWidth":29.875,"prices":{"12":775,"18":843,"24":914}},{"label":"30\" to 36\"","minWidth":30,"maxWidth":36,"prices":{"12":814,"18":885,"24":960}}]},
    {"name":"B-3W","category":"Base Cabinets","ranges":[{"label":"15\" to 20-7/8\"","minWidth":15,"maxWidth":20.875,"prices":{"12":936,"18":1018,"24":1104}},{"label":"21\" to 29-7/8\"","minWidth":21,"maxWidth":29.875,"prices":{"12":983,"18":1069,"24":1159}},{"label":"30\" to 36\"","minWidth":30,"maxWidth":36,"prices":{"12":1032,"18":1122,"24":1217}}]},
];

let orders = [
    {id:2225,company:'Evergreene Companies',name:'EVG FLP2 0005',ship:'04/12/26',status:'bid',builtins:[{cabinetName:'B-O1A',width:15,depth:'24',price:359.1,qty:2},{cabinetName:'B-2WF',width:18,depth:'18',price:803,qty:1}]},
    {id:2224,company:'Evergreene Companies',name:'EVG MAN4 0068',ship:'04/12/26',status:'bid',builtins:[{cabinetName:'B-O1A',width:25,depth:'24',price:435,qty:3}]},
];
let orderIdCounter = 2226;
let currentOrderId = null;
let editingOrderId = null;
let orderBuiltinsList = [];
let selectedCabinetForDim = null;

// UTILS
function fmt(n) { return '$' + n.toFixed(2); }
function getOrder(id) { return orders.find(o => o.id === id); }
function getCabinet(name) { return pricingMatrix.find(c => c.name === name); }

function findPrice(cabinetName, width, depth) {
    const cabinet = getCabinet(cabinetName);
    if (!cabinet || !cabinet.ranges) return 0;
    
    for (const range of cabinet.ranges) {
        if (width >= range.minWidth && width <= range.maxWidth) {
            return range.prices[depth] || 0;
        }
    }
    return 0;
}

function calculateOrderTotal(builtinsList) {
    return builtinsList.reduce((sum, item) => sum + (item.price * item.qty), 0);
}

// NAV
function showPage(page, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    if (btn) btn.classList.add('active');
    if (page === 'matrix') renderMatrix();
}

// ORDERS
function renderOrders() {
    const tbody = document.getElementById('orders-tbody');
    const sortedOrders = [...orders].sort((a, b) => b.id - a.id);
    tbody.innerHTML = sortedOrders.map(o => {
        const st = STATUSES.find(s => s.key === o.status);
        const count = o.builtins.reduce((sum, bi) => sum + bi.qty, 0);
        return `<tr onclick="openOrder(${o.id})" style="cursor:pointer;">
            <td><span class="order-num-badge">${o.id}</span></td>
            <td>${o.company}</td>
            <td>${o.name}</td>
            <td class="num-center">${count}</td>
            <td>${o.ship}</td>
            <td onclick="event.stopPropagation()">
                <div class="status-wrap">
                    <button class="status-badge ${st.cls}" onclick="toggleStatusMenu(event,'menu-list-${o.id}')">${st.label}</button>
                    <div class="status-menu" id="menu-list-${o.id}">${statusMenuHTML(o.id,'list')}</div>
                </div>
            </td>
            <td onclick="event.stopPropagation()">
                <button class="btn btn-ghost btn-icon" onclick="editOrder(${o.id})">‚úèÔ∏è</button>
            </td>
        </tr>`;
    }).join('');
}

function openOrder(id) {
    currentOrderId = id;
    const o = getOrder(id);
    if (!o) return;
    
    document.getElementById('detail-title').textContent = `Order #${o.id} ‚Äì ${o.name}`;
    document.getElementById('detail-subtitle').textContent = `${o.company} ¬∑ Ship: ${o.ship}`;
    document.getElementById('di-order').textContent = '#' + o.id;
    document.getElementById('di-company').textContent = o.company;
    document.getElementById('di-name').textContent = o.name;
    document.getElementById('di-ship').textContent = o.ship;
    const count = o.builtins.reduce((sum, bi) => sum + bi.qty, 0);
    document.getElementById('di-count').textContent = count + ' items';
    
    renderDetailStatus(o);
    renderDetailBuiltins(o);
    
    showPage('order-detail', null);
}

function renderDetailStatus(o) {
    const st = STATUSES.find(s => s.key === o.status);
    document.getElementById('detail-status-wrap').innerHTML = `
        <div class="status-wrap">
            <button class="status-badge ${st.cls}" onclick="toggleStatusMenu(event,'menu-detail')">${st.label}</button>
            <div class="status-menu" id="menu-detail">${statusMenuHTML(o.id,'detail')}</div>
        </div>`;
}

function statusMenuHTML(orderId, context) {
    return STATUSES.map(s =>
        `<div class="status-menu-item" onclick="changeStatus(event,${orderId},'${s.key}','${context}')">
            <span class="status-dot" style="background:${s.dot}"></span>${s.label}
        </div>`
    ).join('');
}

function toggleStatusMenu(e, menuId) {
    e.stopPropagation();
    const menu = document.getElementById(menuId);
    const isOpen = menu.classList.contains('open');
    document.querySelectorAll('.status-menu.open').forEach(m => m.classList.remove('open'));
    if (!isOpen) menu.classList.add('open');
}

function changeStatus(e, orderId, newKey, context) {
    e.stopPropagation();
    const o = getOrder(orderId);
    if (!o) return;
    const oldKey = o.status;
    const oldLabel = STATUSES.find(s => s.key === oldKey).label;
    o.status = newKey;
    const newLabel = STATUSES.find(s => s.key === newKey).label;
    document.querySelectorAll('.status-menu.open').forEach(m => m.classList.remove('open'));
    renderOrders();
    if (context === 'detail') renderDetailStatus(o);
    
    syncOrders(); // Sync to Firebase
    
    // Check if notification should be sent based on settings
    if (shouldSendNotification(oldKey, newKey)) {
        showToast('üìß Notification Sent', `Order #${orderId}: ${oldLabel} ‚Üí ${newLabel}`);
    }
}

function shouldSendNotification(oldStatus, newStatus) {
    // Map of transitions to toggle data attributes
    const transitions = {
        'bid-ordered': { from: 'bid', to: 'ordered' },
        'ordered-verified': { from: 'ordered', to: 'verified' },
        'any-progress': { to: 'progress' },
        'any-hold': { to: 'hold' },
        'any-completed': { to: 'completed' },
        'any-shipped': { to: 'shipped' }
    };
    
    // Check each transition rule
    for (const [toggleName, rule] of Object.entries(transitions)) {
        const toggle = document.querySelector(`[data-transition="${toggleName}"]`);
        if (!toggle || !toggle.classList.contains('on')) continue;
        
        // Check if this transition matches
        if (rule.from) {
            // Specific transition (e.g., bid ‚Üí ordered)
            if (oldStatus === rule.from && newStatus === rule.to) return true;
        } else {
            // Any ‚Üí specific status
            if (newStatus === rule.to) return true;
        }
    }
    
    return false;
}

function renderDetailBuiltins(o) {
    const tbody = document.getElementById('detail-builtins-tbody');
    tbody.innerHTML = o.builtins.map(bi => {
        const total = bi.price * bi.qty;
        return `<tr>
            <td>${bi.cabinetName}</td>
            <td>${bi.width}"</td>
            <td>${bi.depth}"</td>
            <td class="num-right">${bi.qty}</td>
            <td class="num-right">${fmt(bi.price)}</td>
            <td class="num-right">${fmt(total)}</td>
        </tr>`;
    }).join('');
    const orderTotal = calculateOrderTotal(o.builtins);
    document.getElementById('detail-total').textContent = fmt(orderTotal);
}

function backToOrders() {
    currentOrderId = null;
    showPage('orders', document.querySelectorAll('.nav-tab')[0]);
}

function editCurrentOrder() {
    if (currentOrderId) editOrder(currentOrderId);
}

function deleteCurrentOrder() {
    if (!currentOrderId) return;
    if (!confirm(`Delete Order #${currentOrderId}?`)) return;
    orders = orders.filter(o => o.id !== currentOrderId);
    renderOrders();
    syncOrders(); // Sync to Firebase
    backToOrders();
    showToast('üóë Order Deleted', `Order #${currentOrderId} removed`);
}

// ORDER MODAL
function openOrderModal() {
    editingOrderId = null;
    orderBuiltinsList = [];
    document.getElementById('order-number').value = orderIdCounter;
    document.getElementById('order-company').value = '';
    document.getElementById('order-name').value = '';
    document.getElementById('order-status').value = 'bid';
    document.getElementById('order-ship').value = '';
    renderOrderBuiltinsList();
    openModal('modal-order');
}

function editOrder(id) {
    const o = getOrder(id);
    if (!o) return;
    editingOrderId = id;
    orderBuiltinsList = JSON.parse(JSON.stringify(o.builtins));
    document.getElementById('order-number').value = o.id;
    document.getElementById('order-company').value = o.company;
    document.getElementById('order-name').value = o.name;
    document.getElementById('order-status').value = o.status;
    document.getElementById('order-ship').value = o.ship;
    renderOrderBuiltinsList();
    openModal('modal-order');
}

function renderOrderBuiltinsList() {
    const container = document.getElementById('order-builtins-list');
    if (orderBuiltinsList.length === 0) {
        container.innerHTML = '<div class="empty-state">No built-ins added yet</div>';
    } else {
        container.innerHTML = orderBuiltinsList.map((bi, idx) => {
            const total = bi.price * bi.qty;
            return `<div class="selected-builtin-item">
                <span class="selected-builtin-name">${bi.cabinetName} (${bi.width}" W √ó ${bi.depth}" D)</span>
                <input type="number" class="selected-builtin-qty" value="${bi.qty}" min="1" onchange="updateBuiltinQty(${idx}, parseInt(this.value))">
                <span class="selected-builtin-price">${fmt(total)}</span>
                <button class="selected-builtin-remove" onclick="removeBuiltinFromOrder(${idx})">√ó</button>
            </div>`;
        }).join('');
    }
    const total = calculateOrderTotal(orderBuiltinsList);
    document.getElementById('order-modal-total').textContent = fmt(total);
}

function updateBuiltinQty(idx, qty) {
    if (orderBuiltinsList[idx]) {
        orderBuiltinsList[idx].qty = Math.max(1, qty);
        renderOrderBuiltinsList();
    }
}

function removeBuiltinFromOrder(idx) {
    orderBuiltinsList.splice(idx, 1);
    renderOrderBuiltinsList();
}

function saveOrder() {
    const num = parseInt(document.getElementById('order-number').value);
    const company = document.getElementById('order-company').value.trim();
    const name = document.getElementById('order-name').value.trim();
    const status = document.getElementById('order-status').value;
    const ship = document.getElementById('order-ship').value;
    
    if (!num || !company || !name) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (editingOrderId) {
        const o = getOrder(editingOrderId);
        Object.assign(o, {id:num, company, name, status, ship, builtins:orderBuiltinsList});
        showToast('‚úÖ Order Updated', `Order #${num} saved`);
    } else {
        orders.push({id:num, company, name, status, ship, builtins:orderBuiltinsList});
        orderIdCounter = Math.max(orderIdCounter, num + 1);
        showToast('‚úÖ Order Created', `Order #${num} created`);
    }
    
    renderOrders();
    syncOrders(); // Sync to Firebase
    closeModal('modal-order');
}

// BUILTIN SELECTOR
function openBuiltinSelector() {
    renderBuiltinGrid();
    document.getElementById('builtin-selector').classList.add('open');
}

function closeBuiltinSelector() {
    document.getElementById('builtin-selector').classList.remove('open');
}

function renderBuiltinGrid() {
    const grid = document.getElementById('builtin-grid');
    grid.innerHTML = pricingMatrix.map(c => `
        <div class="builtin-card" onclick="selectCabinet('${c.name}')">
            <div class="builtin-card-name">${c.name}</div>
            <div class="builtin-card-category">${c.category || 'Cabinet'}</div>
        </div>
    `).join('');
}

function selectCabinet(name) {
    selectedCabinetForDim = name;
    closeBuiltinSelector();
    openDimensionsModal(name);
}

// DIMENSIONS MODAL
function openDimensionsModal(cabinetName) {
    document.getElementById('dim-modal-title').textContent = 'Specify Dimensions';
    document.getElementById('dim-cabinet-name').textContent = `Cabinet: ${cabinetName}`;
    document.getElementById('dim-width').value = '';
    document.getElementById('dim-depth').value = '24';
    document.getElementById('dim-price').textContent = '$0.00';
    document.getElementById('dim-range-hint').textContent = 'Enter the exact width';
    openModal('modal-dimensions');
}

// Live price calculation as user types
document.addEventListener('DOMContentLoaded', () => {
    const widthInput = document.getElementById('dim-width');
    const depthSelect = document.getElementById('dim-depth');
    
    function updateLivePrice() {
        if (!selectedCabinetForDim) return;
        const width = parseFloat(widthInput.value);
        const depth = depthSelect.value;
        
        if (width && width > 0) {
            const price = findPrice(selectedCabinetForDim, width, depth);
            document.getElementById('dim-price').textContent = fmt(price);
            
            const cabinet = getCabinet(selectedCabinetForDim);
            if (cabinet) {
                for (const range of cabinet.ranges) {
                    if (width >= range.minWidth && width <= range.maxWidth) {
                        document.getElementById('dim-range-hint').textContent = `Falls in range: ${range.label}`;
                        return;
                    }
                }
                document.getElementById('dim-range-hint').textContent = '‚ö†Ô∏è Width outside available ranges';
            }
        } else {
            document.getElementById('dim-price').textContent = '$0.00';
            document.getElementById('dim-range-hint').textContent = 'Enter the exact width';
        }
    }
    
    widthInput?.addEventListener('input', updateLivePrice);
    depthSelect?.addEventListener('change', updateLivePrice);
});

function confirmDimensions() {
    const width = parseFloat(document.getElementById('dim-width').value);
    const depth = document.getElementById('dim-depth').value;
    
    if (!width || width <= 0) {
        alert('Please enter a valid width');
        return;
    }
    
    const price = findPrice(selectedCabinetForDim, width, depth);
    
    if (price === 0) {
        if (!confirm('No price found for this width/depth combination. Add anyway?')) return;
    }
    
    orderBuiltinsList.push({
        cabinetName: selectedCabinetForDim,
        width: width,
        depth: depth,
        price: price,
        qty: 1
    });
    
    renderOrderBuiltinsList();
    closeModal('modal-dimensions');
}

// PRICING MATRIX
function renderMatrix() {
    const tbody = document.getElementById('matrix-tbody');
    tbody.innerHTML = pricingMatrix.map(cabinet => {
        return cabinet.ranges.map((range, rangeIdx) => {
            const isFirstRange = rangeIdx === 0;
            const rowspan = cabinet.ranges.length;
            
            return `<tr>
                ${isFirstRange ? `<td rowspan="${rowspan}" class="range-label">${cabinet.name}</td>` : ''}
                <td class="range-label">${range.label}</td>
                <td><input type="number" value="${range.prices['12'] || ''}" onchange="updatePrice('${cabinet.name}',${rangeIdx},'12',this.value)" step="0.01"></td>
                <td><input type="number" value="${range.prices['18'] || ''}" onchange="updatePrice('${cabinet.name}',${rangeIdx},'18',this.value)" step="0.01"></td>
                <td><input type="number" value="${range.prices['24'] || ''}" onchange="updatePrice('${cabinet.name}',${rangeIdx},'24',this.value)" step="0.01"></td>
                ${isFirstRange ? `<td rowspan="${rowspan}">
                    <button class="btn btn-ghost btn-sm" onclick="editCabinet('${cabinet.name}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteCabinet('${cabinet.name}')">Delete</button>
                </td>` : ''}
            </tr>`;
        }).join('');
    }).join('');
}

function updatePrice(cabinetName, rangeIdx, depth, value) {
    const cabinet = getCabinet(cabinetName);
    if (cabinet && cabinet.ranges[rangeIdx]) {
        const price = parseFloat(value);
        if (!isNaN(price) && price >= 0) {
            cabinet.ranges[rangeIdx].prices[depth] = price;
            syncPricingMatrix(); // Sync to Firebase
            showToast('‚úÖ Price Updated', `${cabinetName} - ${depth}" depth`);
        }
    }
}

function addNewCabinet() {
    editingCabinetName = null;
    rangeRowCount = 0;
    document.getElementById('cabinet-modal-title').textContent = 'Add Cabinet';
    document.getElementById('cabinet-name').value = '';
    document.getElementById('cabinet-category').value = '';
    document.getElementById('range-inputs').innerHTML = '';
    addRangeRow();
    openModal('modal-cabinet');
}

function editCabinet(name) {
    const cabinet = getCabinet(name);
    if (!cabinet) return;
    
    editingCabinetName = name;
    rangeRowCount = 0;
    document.getElementById('cabinet-modal-title').textContent = 'Edit Cabinet';
    document.getElementById('cabinet-name').value = cabinet.name;
    document.getElementById('cabinet-name').disabled = true; // Can't change name
    document.getElementById('cabinet-category').value = cabinet.category || '';
    document.getElementById('range-inputs').innerHTML = '';
    
    cabinet.ranges.forEach(range => {
        addRangeRow(range.label, range.minWidth, range.maxWidth, range.prices['12'], range.prices['18'], range.prices['24']);
    });
    
    openModal('modal-cabinet');
}

let rangeRowCount = 0;
let editingCabinetName = null;

function addRangeRow(label='', minW='', maxW='', p12='', p18='', p24='') {
    const container = document.getElementById('range-inputs');
    const idx = rangeRowCount++;
    const row = document.createElement('div');
    row.id = `range-row-${idx}`;
    row.style.cssText = 'display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 40px;gap:8px;margin-bottom:8px;align-items:center;';
    row.innerHTML = `
        <input type="text" class="form-input" placeholder='e.g., 12" to 17-7/8"' id="range-label-${idx}" value="${label}">
        <input type="number" class="form-input" placeholder="Min" step="0.125" id="range-min-${idx}" value="${minW}">
        <input type="number" class="form-input" placeholder="Max" step="0.125" id="range-max-${idx}" value="${maxW}">
        <input type="number" class="form-input" placeholder="12\" $" step="0.01" id="range-p12-${idx}" value="${p12}">
        <input type="number" class="form-input" placeholder="18\" $" step="0.01" id="range-p18-${idx}" value="${p18}">
        <input type="number" class="form-input" placeholder="24\" $" step="0.01" id="range-p24-${idx}" value="${p24}">
        <button class="btn btn-danger btn-sm" onclick="removeRangeRow(${idx})" style="padding:0;height:38px;">√ó</button>
    `;
    container.appendChild(row);
}

function removeRangeRow(idx) {
    const row = document.getElementById(`range-row-${idx}`);
    if (row) row.remove();
}

function saveCabinet() {
    const name = document.getElementById('cabinet-name').value.trim();
    const category = document.getElementById('cabinet-category').value.trim();
    
    if (!name) {
        alert('Please enter a cabinet name');
        return;
    }
    
    // Collect ranges
    const ranges = [];
    for (let i = 0; i < rangeRowCount; i++) {
        const labelEl = document.getElementById(`range-label-${i}`);
        const minEl = document.getElementById(`range-min-${i}`);
        const maxEl = document.getElementById(`range-max-${i}`);
        const p12El = document.getElementById(`range-p12-${i}`);
        const p18El = document.getElementById(`range-p18-${i}`);
        const p24El = document.getElementById(`range-p24-${i}`);
        
        if (labelEl && minEl && maxEl) {
            const label = labelEl.value.trim();
            const minWidth = parseFloat(minEl.value);
            const maxWidth = parseFloat(maxEl.value);
            const prices = {};
            
            if (p12El.value) prices['12'] = parseFloat(p12El.value);
            if (p18El.value) prices['18'] = parseFloat(p18El.value);
            if (p24El.value) prices['24'] = parseFloat(p24El.value);
            
            if (label && !isNaN(minWidth) && !isNaN(maxWidth)) {
                ranges.push({ label, minWidth, maxWidth, prices });
            }
        }
    }
    
    if (ranges.length === 0) {
        alert('Please add at least one width range');
        return;
    }
    
    if (editingCabinetName) {
        // Update existing
        const cabinet = getCabinet(editingCabinetName);
        if (cabinet) {
            cabinet.category = category;
            cabinet.ranges = ranges;
            showToast('‚úÖ Cabinet Updated', name);
        }
    } else {
        // Add new
        pricingMatrix.push({ name, category, ranges });
        showToast('‚úÖ Cabinet Added', name);
    }
    
    renderMatrix();
    syncPricingMatrix(); // Sync to Firebase
    closeModal('modal-cabinet');
    document.getElementById('cabinet-name').disabled = false;
}

function deleteCabinet(name) {
    if (!confirm(`Delete cabinet "${name}" and all its pricing data?`)) return;
    pricingMatrix = pricingMatrix.filter(c => c.name !== name);
    renderMatrix();
    syncPricingMatrix(); // Sync to Firebase
    showToast('üóë Cabinet Deleted', name);
}

function exportMatrix() {
    alert('Export to CSV - coming soon!');
}

// TOAST
function showToast(title, msg) {
    const tc = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerHTML = `<div class="toast-body"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div>
                   <button class="toast-close" onclick="this.closest('.toast').remove()">√ó</button>`;
    tc.appendChild(t);
    setTimeout(() => { if (t.parentNode) t.remove(); }, 5000);
}

// SETTINGS
function addEmailTag() {
    const input = document.getElementById('new-email-input');
    const email = input.value.trim();
    if (!email || !email.includes('@')) return;
    const tag = document.createElement('span');
    tag.style.cssText = 'display:inline-flex;align-items:center;gap:6px;background:#e3f2fd;color:#1565c0;padding:5px 12px;border-radius:20px;font-size:13px;margin:3px;';
    tag.innerHTML = `${email} <button onclick="this.closest('span').remove();syncNotificationSettings();" style="background:none;border:none;cursor:pointer;color:#1565c0;font-size:16px;line-height:1;">√ó</button>`;
    document.getElementById('email-tags').appendChild(tag);
    input.value = '';
    syncNotificationSettings(); // Sync to Firebase
}

document.addEventListener('DOMContentLoaded', () => {
    // Setup email input handler
    const emailInput = document.getElementById('new-email-input');
    if (emailInput) {
        emailInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); addEmailTag(); }
        });
    }
    
    // Setup toggle sync handlers
    document.querySelectorAll('[data-transition]').forEach(toggle => {
        toggle.addEventListener('click', () => {
            setTimeout(syncNotificationSettings, 100); // Sync after toggle animation
        });
    });
    
    // Load data from Firebase and setup real-time sync
    loadFromFirebaseOnStartup().then(() => {
        setupRealtimeListeners();
    });
});

// MODAL
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); });
});

// GLOBAL CLICK CLOSE MENUS
document.addEventListener('click', () => {
    document.querySelectorAll('.status-menu.open').forEach(m => m.classList.remove('open'));
});

// INIT
renderOrders();
</script>
</body>
</html>